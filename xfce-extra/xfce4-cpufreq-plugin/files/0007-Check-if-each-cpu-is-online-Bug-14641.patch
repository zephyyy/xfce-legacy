From 909c06d15c03c5aa2dbbd99877494cae2d392b87 Mon Sep 17 00:00:00 2001
From: Andre Miranda <andreldm@xfce.org>
Date: Wed, 19 Sep 2018 21:49:34 -0300
Subject: [PATCH 7/8] Check if each cpu is online (Bug #14641)

---
 panel-plugin/xfce4-cpufreq-linux-procfs.c |  2 ++
 panel-plugin/xfce4-cpufreq-linux-sysfs.c  | 13 +++++++++++++
 panel-plugin/xfce4-cpufreq-overview.c     |  1 +
 panel-plugin/xfce4-cpufreq-plugin.c       | 19 +++++++++++++++++--
 panel-plugin/xfce4-cpufreq-plugin.h       |  2 ++
 5 files changed, 35 insertions(+), 2 deletions(-)

diff --git a/panel-plugin/xfce4-cpufreq-linux-procfs.c b/panel-plugin/xfce4-cpufreq-linux-procfs.c
index 87cb34c..c102ddb 100644
--- a/panel-plugin/xfce4-cpufreq-linux-procfs.c
+++ b/panel-plugin/xfce4-cpufreq-linux-procfs.c
@@ -80,6 +80,7 @@ cpufreq_procfs_read_cpuinfo (void)
           cpu->cur_governor = NULL;
           cpu->available_freqs = NULL;
           cpu->available_governors = NULL;
+          cpu->online = TRUE;
           add_cpu = TRUE;
         }
 
@@ -142,6 +143,7 @@ cpufreq_procfs_read (void)
         cpu->cur_governor = g_new (gchar, 20);
         cpu->available_freqs = NULL;
         cpu->available_governors = NULL;
+        cpu->online = TRUE;
 
         sscanf (fileContent,
                 "CPU %*d %d kHz (%*d %%) - %d kHz (%*d %%) - %20s",
diff --git a/panel-plugin/xfce4-cpufreq-linux-sysfs.c b/panel-plugin/xfce4-cpufreq-linux-sysfs.c
index 98f1011..3d11542 100644
--- a/panel-plugin/xfce4-cpufreq-linux-sysfs.c
+++ b/panel-plugin/xfce4-cpufreq-linux-sysfs.c
@@ -70,6 +70,18 @@ cpufreq_sysfs_read_current (gint cpu_number)
   file = g_strdup_printf (SYSFS_BASE"/cpu%i/cpufreq/scaling_governor", cpu_number);
   cpufreq_sysfs_read_string (file, &cpu->cur_governor);
   g_free (file);
+
+  /* read whether the cpu is online, skip first */
+  if (cpu_number != 0)
+  {
+    guint online;
+
+    file = g_strdup_printf (SYSFS_BASE"/cpu%i/online", cpu_number);
+    cpufreq_sysfs_read_int (file, &online);
+    g_free (file);
+
+    cpu->online = online != 0;
+  }
 }
 
 
@@ -169,6 +181,7 @@ parse_sysfs_init (gint cpu_number, CpuInfo *cpu)
 
   if (cpu == NULL) {
     cpu = g_new0 (CpuInfo, 1);
+    cpu->online = TRUE;
     add_cpu = TRUE;
   }
 
diff --git a/panel-plugin/xfce4-cpufreq-overview.c b/panel-plugin/xfce4-cpufreq-overview.c
index 8e35856..d5de670 100644
--- a/panel-plugin/xfce4-cpufreq-overview.c
+++ b/panel-plugin/xfce4-cpufreq-overview.c
@@ -47,6 +47,7 @@ cpufreq_overview_add (CpuInfo *cpu, guint cpu_number, GtkWidget *dialog_hbox)
 	GList 	  *list;
 
 	dialog_vbox = gtk_vbox_new (FALSE, BORDER);
+	gtk_widget_set_sensitive (dialog_vbox, cpu->online);
 	gtk_box_pack_start (GTK_BOX (dialog_hbox), dialog_vbox, TRUE, TRUE, 0);
 
 	hbox = gtk_hbox_new (FALSE, BORDER);
diff --git a/panel-plugin/xfce4-cpufreq-plugin.c b/panel-plugin/xfce4-cpufreq-plugin.c
index b31218e..f758486 100644
--- a/panel-plugin/xfce4-cpufreq-plugin.c
+++ b/panel-plugin/xfce4-cpufreq-plugin.c
@@ -50,6 +50,10 @@ cpufreq_cpus_calc_min (void)
 
 	for (i = 0; i < cpuFreq->cpus->len; i++) {
 		CpuInfo *cpu = g_ptr_array_index (cpuFreq->cpus, i);
+
+		if (!cpu->online)
+			continue;
+
 		if (freq > cpu->cur_freq || i == 0)
 			freq = cpu->cur_freq;
 	}
@@ -64,15 +68,22 @@ cpufreq_cpus_calc_min (void)
 CpuInfo *
 cpufreq_cpus_calc_avg (void)
 {
-	guint freq = 0;
+	guint freq = 0, count = 0;
 	gint i;
 
 	for (i = 0; i < cpuFreq->cpus->len; i++) {
 		CpuInfo *cpu = g_ptr_array_index (cpuFreq->cpus, i);
+
+		if (!cpu->online)
+			continue;
+
 		freq += cpu->cur_freq;
+		count++;
 	}
 
-	freq /= cpuFreq->cpus->len;
+	if (count > 0)
+		freq /= count;
+
 	cpuinfo_free (cpuFreq->cpu_avg);
 	cpuFreq->cpu_avg = g_new0 (CpuInfo, 1);
 	cpuFreq->cpu_avg->cur_freq = freq;
@@ -88,6 +99,10 @@ cpufreq_cpus_calc_max (void)
 
 	for (i = 0; i < cpuFreq->cpus->len; i++) {
 		CpuInfo *cpu = g_ptr_array_index (cpuFreq->cpus, i);
+
+		if (!cpu->online)
+			continue;
+
 		if (freq < cpu->cur_freq)
 			freq = cpu->cur_freq;
 	}
diff --git a/panel-plugin/xfce4-cpufreq-plugin.h b/panel-plugin/xfce4-cpufreq-plugin.h
index 30308d1..4e9d189 100644
--- a/panel-plugin/xfce4-cpufreq-plugin.h
+++ b/panel-plugin/xfce4-cpufreq-plugin.h
@@ -41,6 +41,8 @@ typedef struct
 
 	GList* available_freqs;
 	GList* available_governors;
+	
+	gboolean online;
 } CpuInfo;
 
 typedef struct
-- 
2.45.2

